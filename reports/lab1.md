## 总结

    通过一个公共区域记录简单记录任务id对应的时间和触发调用，简单任务可以运行，如果设计不定任务进入退出，任务号复用等情况无法满足。由于对rust还不是特别熟练，调试过程有点长。

## 简答

1. 正确进入 U 态后，程序的特征还应有：使用 S 态特权指令，访问 S 态寄存器后会报错。 请同学们可以自行测试这些内容（运行 三个 bad 测例 (ch2b_bad_*.rs) ）， 描述程序出错行为，同时注意注明你使用的 sbi 及其版本

`ch2b_bad_address.rs`尝试将u8类型数据写入0x0地址，写入了无效的内存地址
`ch2b_bad_instructions.rs` 尝试在用户态执行s态特权返回指令，指令在用户台下无效
`ch2b_bad_register.rs`  尝试读取csr 寄存器的值并返回到定义的sstatus 变量，用户态无法读取，需要在高特权模式下读取

2.1: L40：刚进入 __restore 时，a0 代表了什么值。请指出 __restore 的两种使用情景。
    a0 代表了参数的起始地址，
   `__restore` 使用场景
- 1 当分时系统触发任务切换调度时需要重启启动就绪队列的任务需要使用
- 2 当系统接受外部中断,并响应完成恢复正在进行的进程时需要使用

2.2 L43-L48：这几行汇编代码特殊处理了哪些寄存器？这些寄存器的的值对于进入用户态有何意义？请分别解释。（GPT）

    ld t0, 32*8(sp): 这行代码从栈上加载一个值到临时寄存器t0。这里32*8(sp)表示栈指针sp加上32个字的偏移量（每个字在RISC-V中通常是8个字节）。这个偏移量对应于sstatus寄存器的保存位置。
    ld t1, 33*8(sp): 这行代码从栈上加载一个值到临时寄存器t1。33*8(sp)表示栈指针sp加上33个字的偏移量，这个偏移量对应于sepc寄存器的保存位置。
    ld t2, 2*8(sp): 这行代码从栈上加载一个值到临时寄存器t2。2*8(sp)表示栈指针sp加上2个字的偏移量，这个偏移量对应于sscratch寄存器的保存位置。
    csrw sstatus, t0: 这行代码将临时寄存器t0中的值写入sstatus寄存器。sstatus寄存器包含了关于处理器状态的各种信息，如全局中断使能、模式切换等。在进入用户态之前，需要确保sstatus寄存器设置了正确的权限级别和中断状态。
    csrw sepc, t1: 这行代码将临时寄存器t1中的值写入sepc寄存器。sepc寄存器保存了异常发生时正在执行的指令的地址。在进入用户态之前，需要将用户态的入口点地址加载到sepc寄存器，这样在执行sret指令返回用户态时，处理器将从该地址继续执行。
    csrw sscratch, t2: 这行代码将临时寄存器t2中的值写入sscratch寄存器。sscratch寄存器通常用于在异常处理过程中保存一个临时寄存器的值。在进入用户态之前，可以将一个重要的寄存器（如栈指针）的值保存到sscratch中，以便在异常返回时快速恢复。

2.3 L50-L56：为何跳过了 x2 和 x4？ (GPT)

    x2（sp）：栈指针（Stack Pointer），用于指向当前任务的栈顶。
    x4（tp）：线程指针（Thread Pointer），通常用于线程局部存储（TLS）。
    这是因为x2（sp）是栈指针，它在这个上下文中被用作基址寄存器来访问栈上的其他寄存器值，而x4（tp）可能被用来访问线程局部存储，因此它们的值通常由运行时环境或线程库管理，而不是直接从栈上加载。

2.4 L60：该指令之后，sp 和 sscratch 中的值分别有什么意义？(GPT)

    这条指令是RISC-V处理器在异常处理和上下文切换中的一个关键步骤，它确保了在处理异常时能够正确地管理栈指针，并在异常处理完成后能够恢复到异常发生前的状态。
    这条指令的目的是交换sp和sscratch寄存器中的值。这条指令通常在进入异常处理时使用，用于保存当前的栈指针，并将栈指针切换到异常处理栈。这样，异常处理代码可以在不干扰原来任务栈的情况下执行

2.5 __restore：中发生状态切换在哪一条指令？为何该指令执行之后会进入用户态？

    发生在 L60，sret; risc-v 规定的 

2.6 L13 该指令之后，sp 和 sscratch 中的值分别有什么意义？

    csrrw sp, sscratch, sp // sp 是当前任务的栈指针，sscratch 通常保留的是异常处理任务栈的指针。 它确保了在处理异常时能够正确地管理栈指针，并在异常处理完成后能够恢复到异常发生前的状态。


2.7 从 U 态进入 S 态是哪一条指令发生的？

    ecall